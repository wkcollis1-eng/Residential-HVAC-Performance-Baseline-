# =============================================================================
# HVAC PERFORMANCE BASELINE - HOME ASSISTANT PACKAGE
# =============================================================================
# Version: 1.3.0
# Repository: https://github.com/wkcollis1-eng/Residential-HVAC-Performance-Baseline-
# License: MIT
#
# A comprehensive HVAC monitoring package implementing Statistical Process
# Control (SPC) methodology for residential heating systems.
#
# INSTALLATION:
# 1. Copy this file to /config/packages/hvac_baseline.yaml
# 2. Ensure packages are enabled in configuration.yaml:
#    homeassistant:
#      packages: !include_dir_named packages
# 3. Restart Home Assistant
# 4. Customize entity IDs in the "USER CONFIGURATION" section below
#
# FEATURES:
# - Runtime per HDD efficiency tracking with ±2σ control limits
# - Multi-zone coordination (Chaining Index)
# - Setback recovery time analysis
# - Climate norms comparison (requires climate_norms_today.py)
# - Automated daily/monthly data capture
# - Filter replacement tracking
# =============================================================================

# =============================================================================
# USER CONFIGURATION - Customize these for your system
# =============================================================================
# Replace these entity IDs with your actual thermostat/sensor entities.
# Search and replace the following placeholders:
#
#   THERMOSTAT_1F    -> Your first floor thermostat (e.g., climate.downstairs)
#   THERMOSTAT_2F    -> Your second floor thermostat (e.g., climate.upstairs)
#   WEATHER_ENTITY   -> Your weather entity (e.g., weather.home)
#   OUTDOOR_TEMP     -> Your outdoor temp sensor (e.g., sensor.outdoor_temperature)
#
# If you have a single-zone system, you can remove all 2F references.
# =============================================================================


# =============================================================================
# INPUT NUMBERS - System Constants & Rolling Window Storage
# =============================================================================
input_number:
  # ===========================================================================
  # SYSTEM CONSTANTS - PLACEHOLDER VALUES
  # ===========================================================================
  # IMPORTANT: The values below are PLACEHOLDERS for demonstration.
  # You MUST replace them with your system's calibrated values!
  #
  # To determine your values:
  # - Furnace BTU/hr: Check your furnace nameplate or spec sheet
  # - Building UA: Derived from heating data analysis (see METHODOLOGY.md)
  # - Balance Point: Typically 55-62°F for high-efficiency homes
  #
  # See the baseline repository documentation for calibration procedures:
  # https://github.com/wkcollis1-eng/Residential-HVAC-Performance-Baseline-
  # ===========================================================================

  hvac_furnace_btu_hr:
    name: Furnace BTU/hr Rating
    min: 40000
    max: 120000
    step: 1000
    unit_of_measurement: "BTU/hr"
    mode: box
    icon: mdi:fire
    initial: 60000  # PLACEHOLDER - Replace with your furnace's input rating

  hvac_building_ua_baseline:
    name: Building UA Baseline
    min: 200
    max: 800
    step: 1
    unit_of_measurement: "BTU/hr-°F"
    mode: box
    icon: mdi:home-thermometer
    initial: 450  # PLACEHOLDER - Derive from your heating data analysis

  hvac_balance_point:
    name: Heating Balance Point
    min: 50
    max: 70
    step: 0.5
    unit_of_measurement: "°F"
    mode: box
    icon: mdi:thermometer-lines
    initial: 59  # PLACEHOLDER - Calibrate based on your home's thermal characteristics

  # --- 7-DAY HDD ROLLING WINDOW ---
  hdd_day_1:
    name: "HDD Day 1 (Today)"
    min: 0
    max: 70
    step: 0.1
    mode: box
  hdd_day_2:
    name: "HDD Day 2"
    min: 0
    max: 70
    step: 0.1
    mode: box
  hdd_day_3:
    name: "HDD Day 3"
    min: 0
    max: 70
    step: 0.1
    mode: box
  hdd_day_4:
    name: "HDD Day 4"
    min: 0
    max: 70
    step: 0.1
    mode: box
  hdd_day_5:
    name: "HDD Day 5"
    min: 0
    max: 70
    step: 0.1
    mode: box
  hdd_day_6:
    name: "HDD Day 6"
    min: 0
    max: 70
    step: 0.1
    mode: box
  hdd_day_7:
    name: "HDD Day 7 (Oldest)"
    min: 0
    max: 70
    step: 0.1
    mode: box

  # --- 7-DAY RUNTIME/HDD ROLLING WINDOW (for std dev) ---
  runtime_per_hdd_day_1:
    name: "Runtime/HDD Day 1"
    min: 0
    max: 200
    step: 0.1
    mode: box
    unit_of_measurement: "min/HDD"
  runtime_per_hdd_day_2:
    name: "Runtime/HDD Day 2"
    min: 0
    max: 200
    step: 0.1
    mode: box
    unit_of_measurement: "min/HDD"
  runtime_per_hdd_day_3:
    name: "Runtime/HDD Day 3"
    min: 0
    max: 200
    step: 0.1
    mode: box
    unit_of_measurement: "min/HDD"
  runtime_per_hdd_day_4:
    name: "Runtime/HDD Day 4"
    min: 0
    max: 200
    step: 0.1
    mode: box
    unit_of_measurement: "min/HDD"
  runtime_per_hdd_day_5:
    name: "Runtime/HDD Day 5"
    min: 0
    max: 200
    step: 0.1
    mode: box
    unit_of_measurement: "min/HDD"
  runtime_per_hdd_day_6:
    name: "Runtime/HDD Day 6"
    min: 0
    max: 200
    step: 0.1
    mode: box
    unit_of_measurement: "min/HDD"
  runtime_per_hdd_day_7:
    name: "Runtime/HDD Day 7"
    min: 0
    max: 200
    step: 0.1
    mode: box
    unit_of_measurement: "min/HDD"

  # --- CUMULATIVE TRACKING ---
  hdd_cumulative_month:
    name: "HDD Cumulative (Month)"
    min: 0
    max: 2000
    step: 0.1
    mode: box
    icon: mdi:snowflake-thermometer

  hdd_cumulative_year:
    name: "HDD Cumulative (Year)"
    min: 0
    max: 10000
    step: 0.1
    mode: box
    icon: mdi:snowflake-thermometer

  # --- FILTER TRACKING ---
  hvac_filter_runtime_hours:
    name: "Filter Runtime Hours"
    min: 0
    max: 2000
    step: 0.1
    unit_of_measurement: "h"
    mode: box
    icon: mdi:air-filter


# =============================================================================
# INPUT DATETIME - Timestamps for data capture validation
# =============================================================================
input_datetime:
  hdd_capture_last_ok:
    name: "Last Successful HDD Capture"
    has_date: true
    has_time: true

  hvac_filter_last_changed:
    name: "Filter Last Changed"
    has_date: true
    has_time: false


# =============================================================================
# INPUT BUTTON - Manual Actions
# =============================================================================
input_button:
  hvac_reset_filter:
    name: "Reset Filter Runtime"
    icon: mdi:air-filter


# =============================================================================
# TEMPLATE SENSORS - Core Metrics
# =============================================================================
template:
  - sensor:
      # --- DEGREE DAY CALCULATIONS ---
      - name: "HVAC HDD65 Today"
        unique_id: hvac_hdd65_today
        unit_of_measurement: "HDD"
        state_class: measurement
        icon: mdi:snowflake-thermometer
        state: >
          {# Replace with your outdoor temp high/low sensors #}
          {% set high = states('sensor.OUTDOOR_TEMP_HIGH_TODAY') | float(0) %}
          {% set low = states('sensor.OUTDOOR_TEMP_LOW_TODAY') | float(0) %}
          {% set mean = (high + low) / 2 %}
          {{ [65 - mean, 0] | max | round(1) }}

      - name: "HVAC CDD65 Today"
        unique_id: hvac_cdd65_today
        unit_of_measurement: "CDD"
        state_class: measurement
        icon: mdi:sun-thermometer
        state: >
          {% set high = states('sensor.OUTDOOR_TEMP_HIGH_TODAY') | float(0) %}
          {% set low = states('sensor.OUTDOOR_TEMP_LOW_TODAY') | float(0) %}
          {% set mean = (high + low) / 2 %}
          {{ [mean - 65, 0] | max | round(1) }}

      - name: "HDD Rolling 7-Day"
        unique_id: hdd_rolling_7_day
        unit_of_measurement: "HDD"
        state_class: measurement
        icon: mdi:calendar-week
        state: >
          {{ (states('input_number.hdd_day_1') | float(0) +
              states('input_number.hdd_day_2') | float(0) +
              states('input_number.hdd_day_3') | float(0) +
              states('input_number.hdd_day_4') | float(0) +
              states('input_number.hdd_day_5') | float(0) +
              states('input_number.hdd_day_6') | float(0) +
              states('input_number.hdd_day_7') | float(0)) | round(1) }}

      # --- RUNTIME TRACKING ---
      - name: "HVAC Total Heat Runtime Today"
        unique_id: hvac_total_heat_runtime_today
        unit_of_measurement: "h"
        state_class: measurement
        state: >
          {{ (states('sensor.hvac_1f_heat_runtime_today') | float(0) +
              states('sensor.hvac_2f_heat_runtime_today') | float(0)) | round(2) }}

      - name: "HVAC Total Heat Runtime Week"
        unique_id: hvac_total_heat_runtime_week
        unit_of_measurement: "h"
        state_class: measurement
        state: >
          {{ (states('sensor.hvac_1f_heat_runtime_week') | float(0) +
              states('sensor.hvac_2f_heat_runtime_week') | float(0)) | round(2) }}

      # --- EFFICIENCY METRICS ---
      - name: "HVAC Runtime per HDD Today"
        unique_id: hvac_runtime_per_hdd_today
        unit_of_measurement: "min/HDD"
        state_class: measurement
        icon: mdi:chart-timeline-variant
        state: >
          {% set runtime = states('sensor.hvac_total_heat_runtime_today') | float(0) %}
          {% set hdd = states('sensor.hvac_hdd65_today') | float(0) %}
          {{ ((runtime * 60) / hdd) | round(1) if hdd > 0 else 0 }}

      - name: "HVAC Runtime per HDD 7-Day"
        unique_id: hvac_runtime_per_hdd_7day
        unit_of_measurement: "min/HDD"
        state_class: measurement
        icon: mdi:chart-line
        state: >
          {% set runtime = states('sensor.hvac_total_heat_runtime_week') | float(0) %}
          {% set hdd = states('sensor.hdd_rolling_7_day') | float(0) %}
          {{ ((runtime * 60) / hdd) | round(1) if hdd > 0 else 0 }}

      # --- STATISTICAL PROCESS CONTROL ---
      - name: "HVAC Runtime per HDD Mean"
        unique_id: hvac_runtime_per_hdd_mean
        unit_of_measurement: "min/HDD"
        state_class: measurement
        icon: mdi:chart-bell-curve
        state: >
          {% set values = [
            states('input_number.runtime_per_hdd_day_1') | float(0),
            states('input_number.runtime_per_hdd_day_2') | float(0),
            states('input_number.runtime_per_hdd_day_3') | float(0),
            states('input_number.runtime_per_hdd_day_4') | float(0),
            states('input_number.runtime_per_hdd_day_5') | float(0),
            states('input_number.runtime_per_hdd_day_6') | float(0),
            states('input_number.runtime_per_hdd_day_7') | float(0)
          ] | select('gt', 0) | list %}
          {% if values | length > 0 %}
            {{ (values | sum / values | length) | round(1) }}
          {% else %}
            0
          {% endif %}

      - name: "HVAC Runtime per HDD Std Dev"
        unique_id: hvac_runtime_per_hdd_stddev
        unit_of_measurement: "min/HDD"
        state_class: measurement
        icon: mdi:sigma
        state: >
          {% set values = [
            states('input_number.runtime_per_hdd_day_1') | float(0),
            states('input_number.runtime_per_hdd_day_2') | float(0),
            states('input_number.runtime_per_hdd_day_3') | float(0),
            states('input_number.runtime_per_hdd_day_4') | float(0),
            states('input_number.runtime_per_hdd_day_5') | float(0),
            states('input_number.runtime_per_hdd_day_6') | float(0),
            states('input_number.runtime_per_hdd_day_7') | float(0)
          ] | select('gt', 0) | list %}
          {% if values | length > 1 %}
            {% set mean = values | sum / values | length %}
            {% set variance = namespace(sum=0) %}
            {% for v in values %}
              {% set variance.sum = variance.sum + ((v - mean) ** 2) %}
            {% endfor %}
            {{ ((variance.sum / (values | length - 1)) ** 0.5) | round(1) }}
          {% else %}
            0
          {% endif %}

      - name: "HVAC Runtime per HDD Upper Bound"
        unique_id: hvac_runtime_per_hdd_upper_bound
        unit_of_measurement: "min/HDD"
        state_class: measurement
        icon: mdi:arrow-up-bold
        state: >
          {% set mean = states('sensor.hvac_runtime_per_hdd_mean') | float(0) %}
          {% set stddev = states('sensor.hvac_runtime_per_hdd_std_dev') | float(0) %}
          {{ (mean + (stddev * 2)) | round(1) if mean > 0 else 0 }}

      - name: "HVAC Runtime per HDD Lower Bound"
        unique_id: hvac_runtime_per_hdd_lower_bound
        unit_of_measurement: "min/HDD"
        state_class: measurement
        icon: mdi:arrow-down-bold
        state: >
          {% set mean = states('sensor.hvac_runtime_per_hdd_mean') | float(0) %}
          {% set stddev = states('sensor.hvac_runtime_per_hdd_std_dev') | float(0) %}
          {% set lower = mean - (stddev * 2) %}
          {{ lower | round(1) if lower > 0 else 0 }}

      - name: "HVAC Runtime per HDD Data Count"
        unique_id: hvac_runtime_per_hdd_data_count
        unit_of_measurement: "days"
        state_class: measurement
        icon: mdi:counter
        state: >
          {% set values = [
            states('input_number.runtime_per_hdd_day_1') | float(0),
            states('input_number.runtime_per_hdd_day_2') | float(0),
            states('input_number.runtime_per_hdd_day_3') | float(0),
            states('input_number.runtime_per_hdd_day_4') | float(0),
            states('input_number.runtime_per_hdd_day_5') | float(0),
            states('input_number.runtime_per_hdd_day_6') | float(0),
            states('input_number.runtime_per_hdd_day_7') | float(0)
          ] | select('gt', 0) | list %}
          {{ values | length }}

      # --- ZONE BALANCE (Multi-Zone Systems) ---
      - name: "HVAC Zone Balance Ratio"
        unique_id: hvac_zone_balance_ratio
        unit_of_measurement: "%"
        state_class: measurement
        icon: mdi:scale-balance
        state: >
          {% set r1 = states('sensor.hvac_1f_heat_runtime_today') | float(0) %}
          {% set r2 = states('sensor.hvac_2f_heat_runtime_today') | float(0) %}
          {% set total = r1 + r2 %}
          {{ ((r2 / total) * 100) | round(1) if total > 0 else 50 }}

      - name: "HVAC Zone Balance Status"
        unique_id: hvac_zone_balance_status
        icon: mdi:home-floor-1
        state: >
          {% set ratio = states('sensor.hvac_zone_balance_ratio') | float(50) %}
          {% if ratio >= 40 and ratio <= 60 %}Balanced
          {% elif ratio > 60 %}2F Heavy
          {% else %}1F Heavy{% endif %}

      - name: "HVAC Total Cycles Today"
        unique_id: hvac_total_cycles_today
        unit_of_measurement: "cycles"
        state_class: measurement
        state: >
          {{ states('sensor.hvac_1f_heat_cycles_today') | int(0) + 
             states('sensor.hvac_2f_heat_cycles_today') | int(0) }}

      # --- CHAINING INDEX (Novel Multi-Zone Metric) ---
      - name: "HVAC Chaining Index"
        unique_id: hvac_chaining_index
        state_class: measurement
        icon: mdi:link-variant
        state: >
          {% set zone_calls = states('sensor.hvac_1f_heat_cycles_today') | int(0) + 
                              states('sensor.hvac_2f_heat_cycles_today') | int(0) %}
          {% set furnace_cycles = states('sensor.hvac_furnace_cycles_today') | int(0) %}
          {% if furnace_cycles > 0 %}
            {{ (zone_calls / furnace_cycles) | round(2) }}
          {% else %}
            1.0
          {% endif %}
        attributes:
          interpretation: >
            {% set ci = this.state | float(1) %}
            {% if ci < 1.1 %}No zone coordination
            {% elif ci < 1.5 %}Moderate chaining
            {% else %}High coordination{% endif %}

      # --- FILTER TRACKING ---
      - name: "HVAC Filter Hours Remaining"
        unique_id: hvac_filter_hours_remaining
        unit_of_measurement: "h"
        state_class: measurement
        icon: mdi:air-filter
        state: >
          {{ (1000 - states('input_number.hvac_filter_runtime_hours') | float(0)) | round(0) }}

  # --- BINARY SENSORS (Alerts) ---
  - binary_sensor:
      - name: "HVAC Furnace Running"
        unique_id: hvac_furnace_running
        device_class: running
        icon: mdi:fire
        state: >
          {{ is_state('binary_sensor.hvac_1f_call_for_heat', 'on') or
             is_state('binary_sensor.hvac_2f_call_for_heat', 'on') }}

      - name: "HVAC 1F Call for Heat"
        unique_id: hvac_1f_call_for_heat
        device_class: heat
        state: >
          {# Replace THERMOSTAT_1F with your thermostat entity #}
          {{ state_attr('climate.THERMOSTAT_1F', 'hvac_action') == 'heating' }}

      - name: "HVAC 2F Call for Heat"
        unique_id: hvac_2f_call_for_heat
        device_class: heat
        state: >
          {# Replace THERMOSTAT_2F with your thermostat entity #}
          {{ state_attr('climate.THERMOSTAT_2F', 'hvac_action') == 'heating' }}

      - name: "HVAC Runtime per HDD High Alert"
        unique_id: hvac_runtime_per_hdd_high_alert
        device_class: problem
        icon: mdi:alert-circle
        state: >
          {% set current = states('sensor.hvac_runtime_per_hdd_7_day') | float(0) %}
          {% set upper = states('sensor.hvac_runtime_per_hdd_upper_bound') | float(0) %}
          {% set count = states('sensor.hvac_runtime_per_hdd_data_count') | int(0) %}
          {{ current > upper and upper > 0 and count >= 4 }}

      - name: "HVAC Zone Imbalance Alert"
        unique_id: hvac_zone_imbalance_alert
        device_class: problem
        icon: mdi:scale-unbalanced
        state: >
          {% set ratio = states('sensor.hvac_zone_balance_ratio') | float(50) %}
          {% set runtime = states('sensor.hvac_total_heat_runtime_today') | float(0) %}
          {{ (ratio < 35 or ratio > 65) and runtime > 1 }}

      - name: "HVAC Filter Change Alert"
        unique_id: hvac_filter_change_alert
        device_class: problem
        icon: mdi:air-filter
        state: >
          {{ states('input_number.hvac_filter_runtime_hours') | float(0) >= 1000 }}


# =============================================================================
# HISTORY STATS - Runtime Tracking
# =============================================================================
sensor:
  - platform: history_stats
    name: "HVAC 1F Heat Runtime Today"
    unique_id: hvac_1f_heat_runtime_today
    entity_id: binary_sensor.hvac_1f_call_for_heat
    state: "on"
    type: time
    start: "{{ now().replace(hour=0, minute=0, second=0, microsecond=0) }}"
    end: "{{ now() }}"

  - platform: history_stats
    name: "HVAC 2F Heat Runtime Today"
    unique_id: hvac_2f_heat_runtime_today
    entity_id: binary_sensor.hvac_2f_call_for_heat
    state: "on"
    type: time
    start: "{{ now().replace(hour=0, minute=0, second=0, microsecond=0) }}"
    end: "{{ now() }}"

  - platform: history_stats
    name: "HVAC 1F Heat Cycles Today"
    unique_id: hvac_1f_heat_cycles_today
    entity_id: binary_sensor.hvac_1f_call_for_heat
    state: "on"
    type: count
    start: "{{ now().replace(hour=0, minute=0, second=0, microsecond=0) }}"
    end: "{{ now() }}"

  - platform: history_stats
    name: "HVAC 2F Heat Cycles Today"
    unique_id: hvac_2f_heat_cycles_today
    entity_id: binary_sensor.hvac_2f_call_for_heat
    state: "on"
    type: count
    start: "{{ now().replace(hour=0, minute=0, second=0, microsecond=0) }}"
    end: "{{ now() }}"

  - platform: history_stats
    name: "HVAC 1F Heat Runtime Week"
    unique_id: hvac_1f_heat_runtime_week
    entity_id: binary_sensor.hvac_1f_call_for_heat
    state: "on"
    type: time
    start: "{{ now() - timedelta(days=7) }}"
    end: "{{ now() }}"

  - platform: history_stats
    name: "HVAC 2F Heat Runtime Week"
    unique_id: hvac_2f_heat_runtime_week
    entity_id: binary_sensor.hvac_2f_call_for_heat
    state: "on"
    type: time
    start: "{{ now() - timedelta(days=7) }}"
    end: "{{ now() }}"

  - platform: history_stats
    name: "HVAC Furnace Cycles Today"
    unique_id: hvac_furnace_cycles_today
    entity_id: binary_sensor.hvac_furnace_running
    state: "on"
    type: count
    start: "{{ now().replace(hour=0, minute=0, second=0, microsecond=0) }}"
    end: "{{ now() }}"

  - platform: history_stats
    name: "HVAC Furnace Runtime Today"
    unique_id: hvac_furnace_runtime_today
    entity_id: binary_sensor.hvac_furnace_running
    state: "on"
    type: time
    start: "{{ now().replace(hour=0, minute=0, second=0, microsecond=0) }}"
    end: "{{ now() }}"


# =============================================================================
# AUTOMATIONS - Daily Data Capture
# =============================================================================
automation:
  # --- DAILY HDD CAPTURE (11:55 PM) ---
  - id: hvac_baseline_capture_daily_hdd
    alias: "HVAC Baseline: Capture Daily HDD"
    description: "Records daily HDD and updates rolling/cumulative totals"
    mode: single
    trigger:
      - platform: time
        at: "23:55:00"
    condition:
      - condition: template
        value_template: >
          {{ is_number(states('sensor.hvac_hdd65_today')) and
             0 <= (states('sensor.hvac_hdd65_today') | float) <= 65 }}
    action:
      - variables:
          todays_hdd: "{{ states('sensor.hvac_hdd65_today') | float }}"
          d1: "{{ states('input_number.hdd_day_1') | float(0) }}"
          d2: "{{ states('input_number.hdd_day_2') | float(0) }}"
          d3: "{{ states('input_number.hdd_day_3') | float(0) }}"
          d4: "{{ states('input_number.hdd_day_4') | float(0) }}"
          d5: "{{ states('input_number.hdd_day_5') | float(0) }}"
          d6: "{{ states('input_number.hdd_day_6') | float(0) }}"
      # Shift values (FIFO queue)
      - service: input_number.set_value
        target:
          entity_id: input_number.hdd_day_7
        data:
          value: "{{ d6 }}"
      - service: input_number.set_value
        target:
          entity_id: input_number.hdd_day_6
        data:
          value: "{{ d5 }}"
      - service: input_number.set_value
        target:
          entity_id: input_number.hdd_day_5
        data:
          value: "{{ d4 }}"
      - service: input_number.set_value
        target:
          entity_id: input_number.hdd_day_4
        data:
          value: "{{ d3 }}"
      - service: input_number.set_value
        target:
          entity_id: input_number.hdd_day_3
        data:
          value: "{{ d2 }}"
      - service: input_number.set_value
        target:
          entity_id: input_number.hdd_day_2
        data:
          value: "{{ d1 }}"
      - service: input_number.set_value
        target:
          entity_id: input_number.hdd_day_1
        data:
          value: "{{ todays_hdd }}"
      # Update cumulative
      - service: input_number.set_value
        target:
          entity_id: input_number.hdd_cumulative_month
        data:
          value: "{{ (states('input_number.hdd_cumulative_month') | float(0) + todays_hdd) | round(1) }}"
      - service: input_number.set_value
        target:
          entity_id: input_number.hdd_cumulative_year
        data:
          value: "{{ (states('input_number.hdd_cumulative_year') | float(0) + todays_hdd) | round(1) }}"
      # Record timestamp
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.hdd_capture_last_ok
        data:
          datetime: "{{ now().strftime('%Y-%m-%d %H:%M:%S') }}"

  # --- DAILY RUNTIME/HDD CAPTURE (11:56 PM) ---
  - id: hvac_baseline_capture_daily_runtime_per_hdd
    alias: "HVAC Baseline: Capture Daily Runtime/HDD"
    description: "Records daily runtime/HDD for statistical analysis"
    mode: single
    trigger:
      - platform: time
        at: "23:56:00"
    condition:
      - condition: template
        value_template: >
          {{ is_number(states('sensor.hvac_runtime_per_hdd_today')) and
             states('sensor.hvac_hdd65_today') | float(0) > 0 }}
    action:
      - variables:
          todays_val: "{{ states('sensor.hvac_runtime_per_hdd_today') | float }}"
          d1: "{{ states('input_number.runtime_per_hdd_day_1') | float(0) }}"
          d2: "{{ states('input_number.runtime_per_hdd_day_2') | float(0) }}"
          d3: "{{ states('input_number.runtime_per_hdd_day_3') | float(0) }}"
          d4: "{{ states('input_number.runtime_per_hdd_day_4') | float(0) }}"
          d5: "{{ states('input_number.runtime_per_hdd_day_5') | float(0) }}"
          d6: "{{ states('input_number.runtime_per_hdd_day_6') | float(0) }}"
      - service: input_number.set_value
        target:
          entity_id: input_number.runtime_per_hdd_day_7
        data:
          value: "{{ d6 }}"
      - service: input_number.set_value
        target:
          entity_id: input_number.runtime_per_hdd_day_6
        data:
          value: "{{ d5 }}"
      - service: input_number.set_value
        target:
          entity_id: input_number.runtime_per_hdd_day_5
        data:
          value: "{{ d4 }}"
      - service: input_number.set_value
        target:
          entity_id: input_number.runtime_per_hdd_day_4
        data:
          value: "{{ d3 }}"
      - service: input_number.set_value
        target:
          entity_id: input_number.runtime_per_hdd_day_3
        data:
          value: "{{ d2 }}"
      - service: input_number.set_value
        target:
          entity_id: input_number.runtime_per_hdd_day_2
        data:
          value: "{{ d1 }}"
      - service: input_number.set_value
        target:
          entity_id: input_number.runtime_per_hdd_day_1
        data:
          value: "{{ todays_val }}"

  # --- FILTER RUNTIME UPDATE (Hourly) ---
  - id: hvac_baseline_update_filter_runtime
    alias: "HVAC Baseline: Update Filter Runtime"
    description: "Accumulates furnace runtime for filter tracking"
    mode: single
    trigger:
      - platform: time_pattern
        hours: "/1"
    action:
      - service: input_number.set_value
        target:
          entity_id: input_number.hvac_filter_runtime_hours
        data:
          value: >
            {{ (states('input_number.hvac_filter_runtime_hours') | float(0) +
                states('sensor.hvac_furnace_runtime_today') | float(0)) | round(1) }}

  # --- FILTER RESET BUTTON ---
  - id: hvac_baseline_reset_filter
    alias: "HVAC Baseline: Reset Filter Runtime"
    trigger:
      - platform: state
        entity_id: input_button.hvac_reset_filter
    action:
      - service: input_number.set_value
        target:
          entity_id: input_number.hvac_filter_runtime_hours
        data:
          value: 0
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.hvac_filter_last_changed
        data:
          date: "{{ now().strftime('%Y-%m-%d') }}"
      - service: persistent_notification.create
        data:
          title: "✅ Filter Runtime Reset"
          message: "Filter runtime counter reset. Next change due at 1000 hours."

  # --- MONTHLY RESET ---
  - id: hvac_baseline_reset_monthly
    alias: "HVAC Baseline: Monthly Reset"
    trigger:
      - platform: time
        at: "00:01:00"
    condition:
      - condition: template
        value_template: "{{ now().day == 1 }}"
    action:
      - service: input_number.set_value
        target:
          entity_id: input_number.hdd_cumulative_month
        data:
          value: 0

  # --- YEARLY RESET ---
  - id: hvac_baseline_reset_yearly
    alias: "HVAC Baseline: Yearly Reset"
    trigger:
      - platform: time
        at: "00:02:00"
    condition:
      - condition: template
        value_template: "{{ now().month == 1 and now().day == 1 }}"
    action:
      - service: input_number.set_value
        target:
          entity_id: input_number.hdd_cumulative_year
        data:
          value: 0


# =============================================================================
# END OF PACKAGE
# =============================================================================
# For questions or contributions, see:
# https://github.com/wkcollis1-eng/Residential-HVAC-Performance-Baseline-
# =============================================================================
